# Feature Specification: 用户登录态检查

**Feature Branch**: `002-login-guard`
**Created**: 2025-12-31
**Status**: Draft
**Input**: User description: "添加用户登录态检查功能，未登录的用户无法访问页面，会被自动跳转到统一登录页（已有，不需要在此项目开发）进行登录后才能正常访问此页面"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 未登录用户访问受保护页面被拦截 (Priority: P1)

作为一个未登录的用户，当我尝试访问应用的任何页面时，系统会检测到我未登录并自动将我重定向到统一登录页面，以确保只有经过身份验证的用户才能访问应用内容。

**Why this priority**: 这是整个功能的核心，没有登录态检查就无法保护任何页面。这是安全性的基础保障。

**Independent Test**: 可以通过清除浏览器登录凭证后直接访问应用任意页面来测试，验证是否被重定向到登录页。

**Acceptance Scenarios**:

1. **Given** 用户未登录（无有效登录凭证），**When** 用户尝试访问应用的账单列表页面，**Then** 用户被自动重定向到统一登录页面
2. **Given** 用户未登录（无有效登录凭证），**When** 用户尝试访问应用的统计页面，**Then** 用户被自动重定向到统一登录页面
3. **Given** 用户未登录（无有效登录凭证），**When** 用户尝试直接访问深层链接（如特定账单详情），**Then** 用户被自动重定向到统一登录页面

---

### User Story 2 - 已登录用户正常访问页面 (Priority: P1)

作为一个已经登录的用户，当我访问应用的任何页面时，系统能够识别我的有效登录状态，允许我正常访问页面内容而不会被重定向。

**Why this priority**: 与 P1-1 同等重要，确保登录检查不会阻止合法用户访问。

**Independent Test**: 可以通过使用有效登录凭证访问应用任意页面来测试，验证能够正常显示页面内容。

**Acceptance Scenarios**:

1. **Given** 用户已登录（持有有效登录凭证），**When** 用户访问应用的账单列表页面，**Then** 页面正常显示账单列表内容
2. **Given** 用户已登录（持有有效登录凭证），**When** 用户在页面间导航，**Then** 所有页面均可正常访问无需重复登录
3. **Given** 用户已登录（持有有效登录凭证），**When** 用户刷新当前页面，**Then** 页面正常重新加载而非跳转到登录页

---

### User Story 3 - 登录成功后返回原页面 (Priority: P2)

作为一个完成登录的用户，当我从统一登录页登录成功后，系统能够将我重定向回我最初尝试访问的页面，提供流畅的用户体验。

**Why this priority**: 提升用户体验的重要功能，但不影响核心安全功能。

**Independent Test**: 可以通过未登录状态访问特定页面、完成登录后验证是否返回该页面来测试。

**Acceptance Scenarios**:

1. **Given** 用户未登录时尝试访问账单详情页，**When** 用户在登录页完成登录，**Then** 用户被自动重定向回账单详情页
2. **Given** 用户未登录时尝试访问统计页面，**When** 用户在登录页完成登录，**Then** 用户被自动重定向回统计页面

---

### User Story 4 - 登录状态过期处理 (Priority: P2)

作为一个登录状态已过期的用户，当我的登录凭证失效时，系统能够检测到并引导我重新登录，同时保持良好的用户体验。

**Why this priority**: 处理实际使用中常见的登录过期场景，确保安全性的同时提供合理的用户体验。

**Independent Test**: 可以通过等待登录凭证过期或手动使凭证失效后继续操作来测试。

**Acceptance Scenarios**:

1. **Given** 用户登录状态已过期，**When** 用户尝试访问任何页面，**Then** 用户被重定向到统一登录页面
2. **Given** 用户正在操作页面时登录状态过期，**When** 用户执行需要认证的操作，**Then** 系统提示需要重新登录并引导用户到登录页

---

### Edge Cases

- **网络中断处理**: 登录状态检查过程中网络中断时，立即显示错误提示并提供重试按钮
- **多标签页同步**: 用户在多个浏览器标签页同时操作，其中一个标签页退出登录后，其他标签页在下次操作时检测到未授权状态并引导重新登录
- **登录页不可用**: 统一登录页无法访问时，显示友好的错误提示，告知用户稍后重试
- **凭证损坏处理**: 用户凭证格式损坏或无法解析时，清除本地凭证并引导用户重新登录

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须在用户访问任何受保护页面前检查登录状态
- **FR-002**: 系统必须在检测到用户未登录时，自动重定向用户到统一登录页面
- **FR-003**: 系统必须在重定向到登录页时通过 `redirectUrl` 参数保存用户原始请求的完整 URL
- **FR-004**: 系统必须在用户登录成功后将用户重定向回原始请求的页面
- **FR-005**: 系统必须能够识别并验证用户的登录凭证有效性
- **FR-006**: 系统必须能够处理登录凭证过期的情况并引导用户重新登录
- **FR-007**: 系统必须确保登录状态检查对已登录用户透明，不影响正常使用体验
- **FR-008**: 系统必须在后端请求返回未授权状态时触发重新登录流程
- **FR-009**: 后端必须在 CH-USER header 缺失时返回 401 Unauthorized，拒绝请求

### Key Entities

- **用户会话 (User Session)**: 表示用户的登录状态，包含用户身份标识和有效期信息
- **登录凭证 (Login Credential)**: 用于验证用户身份的令牌或标识，与统一登录系统对接

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% 的未授权访问尝试被正确拦截并重定向到登录页
- **SC-002**: 已登录用户页面加载时间增加不超过 100 毫秒（登录状态检查开销）
- **SC-003**: 登录成功后 95% 的用户能够被正确重定向回原始请求页面
- **SC-004**: 登录状态过期后 3 秒内用户被引导到重新登录流程

## Clarifications

### Session 2025-12-31

- Q: 统一登录页面的 URL 如何获取？ → A: 硬编码在前端配置文件中
- Q: 登录凭证（Token）在浏览器端如何存储？ → A: Cookie 存储（支持 HttpOnly，更安全）
- Q: 网络请求失败时应如何处理？ → A: 立即显示错误提示，提供重试按钮
- Q: 后端认证策略：是否需要后端 AuthGuard 双重校验？ → A: 信任 Fence 网关，后端只读 CH-USER header（网关已完成 JWT 验证）
- Q: 后端 CH-USER header 缺失时如何处理？ → A: 返回 401 Unauthorized（拒绝请求，不使用默认值）
- Q: 重定向参数名称和格式？ → A: 参数名 `redirectUrl`，值为完整 URL（非相对路径）

## Assumptions

- 统一登录页面已经存在且可用，本功能只需与其对接
- 统一登录页 URL 在前端配置文件中硬编码配置
- 登录凭证使用 Cookie 存储，设置 HttpOnly 属性以增强安全性
- 所有应用页面都需要登录保护，没有公开可访问的页面
- 统一登录系统提供回调机制，支持登录成功后返回原页面
- **认证架构**：Fence API 网关负责 JWT 验证，后端信任网关传递的 CH-USER header，不做重复校验

## Dependencies

- 统一登录系统：提供登录页面和身份验证服务
- 统一登录系统的凭证格式和验证接口规范

## Out of Scope

- 登录页面的开发和维护（由统一登录系统负责）
- 用户注册功能
- 密码找回功能
- 多因素认证的实现
- 用户权限管理（区分不同角色的访问权限）
